const { ethers } = require("hardhat");

async function main() {
    console.log("ğŸš€ å¼€å§‹å®Œæ•´çš„é’±åŒ…å’Œåˆçº¦äº¤äº’æµ‹è¯•...\n");

    // è·å–æµ‹è¯•è´¦æˆ·
    const [signer1, signer2, signer3] = await ethers.getSigners();
    console.log("ğŸ“ æµ‹è¯•è´¦æˆ·:");
    console.log("  è´¦æˆ·1:", signer1.address);
    console.log("  è´¦æˆ·2:", signer2.address);
    console.log("  è´¦æˆ·3:", signer3.address);

    // æ£€æŸ¥åˆå§‹ä½™é¢
    console.log("\nğŸ’° åˆå§‹ä½™é¢:");
    const balance1 = await ethers.provider.getBalance(signer1.address);
    const balance2 = await ethers.provider.getBalance(signer2.address);
    console.log("  è´¦æˆ·1ä½™é¢:", ethers.formatEther(balance1), "ETH");
    console.log("  è´¦æˆ·2ä½™é¢:", ethers.formatEther(balance2), "ETH");

    // éƒ¨ç½²åˆçº¦
    console.log("\nğŸ“„ éƒ¨ç½²åˆçº¦...");
    const TransferDemo = await ethers.getContractFactory("TransferDemo");
    const transferDemo = await TransferDemo.deploy();
    await transferDemo.waitForDeployment();
    const contractAddress = await transferDemo.getAddress();
    console.log("  åˆçº¦åœ°å€:", contractAddress);

    const contractBalance = await ethers.provider.getBalance(contractAddress);
    console.log("  åˆçº¦åˆå§‹ä½™é¢:", ethers.formatEther(contractBalance), "ETH");

    // æµ‹è¯•1: å­˜æ¬¾åˆ°åˆçº¦
    console.log("\n1ï¸âƒ£ æµ‹è¯•å­˜æ¬¾åŠŸèƒ½...");
    const depositAmount = ethers.parseEther("0.5");
    const depositTx = await transferDemo.deposit({ value: depositAmount });
    await depositTx.wait();
    console.log("  âœ… å­˜æ¬¾æˆåŠŸ:", ethers.formatEther(depositAmount), "ETH");

    // æµ‹è¯•2: è¯»å–å­˜æ¬¾ä½™é¢
    const userBalance = await transferDemo.getBalance(signer1.address);
    const currentContractBalance = await transferDemo.getContractBalance();
    console.log("  ç”¨æˆ·åˆçº¦ä½™é¢:", ethers.formatEther(userBalance), "ETH");
    console.log("  åˆçº¦æ€»ä½™é¢:", ethers.formatEther(currentContractBalance), "ETH");

    // æµ‹è¯•3: è´¦æˆ·é—´è½¬è´¦ï¼ˆåœ¨åˆçº¦å†…ï¼‰
    console.log("\n2ï¸âƒ£ æµ‹è¯•åˆçº¦å†…è½¬è´¦...");
    const transferAmount = ethers.parseEther("0.1");
    const transferTx = await transferDemo.transferTo(signer2.address, transferAmount);
    await transferTx.wait();
    console.log("  âœ… è½¬è´¦æˆåŠŸ:", ethers.formatEther(transferAmount), "ETH");
    console.log("    ä»:", signer1.address);
    console.log("    åˆ°:", signer2.address);

    // æ£€æŸ¥è½¬è´¦åä½™é¢
    const balanceAfterTransfer1 = await transferDemo.getBalance(signer1.address);
    const balanceAfterTransfer2 = await transferDemo.getBalance(signer2.address);
    console.log("  è´¦æˆ·1åˆçº¦ä½™é¢:", ethers.formatEther(balanceAfterTransfer1), "ETH");
    console.log("  è´¦æˆ·2åˆçº¦ä½™é¢:", ethers.formatEther(balanceAfterTransfer2), "ETH");

    // æµ‹è¯•4: ç›´æ¥ETHè½¬è´¦
    console.log("\n3ï¸âƒ£ æµ‹è¯•ç›´æ¥ETHè½¬è´¦...");
    const directAmount = ethers.parseEther("0.05");
    const directTx = await transferDemo.directTransfer(signer2.address, { value: directAmount });
    await directTx.wait();
    console.log("  âœ… ç›´æ¥è½¬è´¦æˆåŠŸ:", ethers.formatEther(directAmount), "ETH");

    // æµ‹è¯•5: å–æ¬¾
    console.log("\n4ï¸âƒ£ æµ‹è¯•å–æ¬¾åŠŸèƒ½...");
    const withdrawAmount = ethers.parseEther("0.2");
    const withdrawTx = await transferDemo.withdraw(withdrawAmount);
    await withdrawTx.wait();
    console.log("  âœ… å–æ¬¾æˆåŠŸ:", ethers.formatEther(withdrawAmount), "ETH");

    // æœ€ç»ˆä½™é¢æ£€æŸ¥
    console.log("\nğŸ“Š æœ€ç»ˆä½™é¢ç»Ÿè®¡:");
    const finalBalance1 = await ethers.provider.getBalance(signer1.address);
    const finalBalance2 = await ethers.provider.getBalance(signer2.address);
    const finalContractBalance = await ethers.provider.getBalance(contractAddress);

    console.log("  è´¦æˆ·1ä½™é¢:", ethers.formatEther(finalBalance1), "ETH");
    console.log("  è´¦æˆ·2ä½™é¢:", ethers.formatEther(finalBalance2), "ETH");
    console.log("  åˆçº¦ä½™é¢:", ethers.formatEther(finalContractBalance), "ETH");

    // åˆçº¦çŠ¶æ€æ£€æŸ¥
    console.log("\nğŸ“‹ åˆçº¦çŠ¶æ€:");
    const contractStateBalance = await transferDemo.getContractBalance();
    const user1StateBalance = await transferDemo.getBalance(signer1.address);
    const user2StateBalance = await transferDemo.getBalance(signer2.address);

    console.log("  åˆçº¦è®°å½•çš„æ€»ä½™é¢:", ethers.formatEther(contractStateBalance), "ETH");
    console.log("  åˆçº¦è®°å½•çš„è´¦æˆ·1ä½™é¢:", ethers.formatEther(user1StateBalance), "ETH");
    console.log("  åˆçº¦è®°å½•çš„è´¦æˆ·2ä½™é¢:", ethers.formatEther(user2StateBalance), "ETH");

    console.log("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ!");
}

main().catch((error) => {
    console.error("âŒ é”™è¯¯:", error);
    process.exitCode = 1;
});